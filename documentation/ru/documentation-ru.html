<!DOCTYPE html>
<html lang="ru">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* {
    margin:  0px;
    padding: 0px;
    border:  0px; 
}

html {
    height: 100%;
    font: 14px Verdana, Arial, Helvetica, sans-serif;
}

body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

div {
    text-align: justify;	
}

p {
    padding: 5px;
}

ul {
    padding-left: 20px;
}

li {
    padding-top: 2px;
    padding-bottom: 2px;
}

a, a:link, a:active, a:visited {
   #color: #0000EE;
   color: #0000DD;
   #color: red;
}

.background-header {
    background: #F7F7FF;
}

.background-menu {
    background: #D0E0FF;
}

.background-menu-line {
    background: #90A0C0;
}

.border-color-menu {
    border-color: #90A0C0;
}

.color-menu-item {
    color: #2020A0;
}

.color-menu-item-selected { 
    color: #E78C43; 
}

.background-menu-selected-top { 
    background: #C8D8E8;
}

.border-color-div-source-code {
    border-color: #909090;
}

.color-source-sql-comment {
    color: #008000;
}

.color-source-sql-string {
    color: #800060;
}

.color-source-sql-keyword {
    color: #000080;
}

.color-source-sql-block-border {
    color: #DD0000;
}

.color-source-shell {
    color: green;
}

.background-source-shell {
    background: black;    
}

.color-source-html-tag {
    color: #0000CD;
}

.color-source-html-tag-attrubites {
    color: #B22222;
}

.color-source-html-tag-value {
    color: #008000;
}

.color-source-html-comment {
    color: #808080;
}

.color-source-js-comment {
    color: #008000;
}

.color-source-js-keyword {
    color: #000080;
}

.color-source-js-string {
    color: #800060;
}

.div-page {
    #border: solid 3px red;
    display: flex;
    flex-wrap: nowrap;
}

.div-header-middle {
    #border: solid 3px green;
    display: flex; 
    align-items: center; 
    justify-content: center;
	text-align: center;
}

.div-header-sidebar {
    #border: solid 3px blue;
    display: flex;    
    justify-content: center; 
    align-items: center;
    width: 100%;
} 

.div-content {
    display: flex;
    flex-wrap: nowrap;
    #justify-content: space-evenly; 
    justify-content: space-between;
}

.div-content-panel-left {
    #border: solid 3px green;
    width:     260px;
    min-width: 260px;
    max-width: 260px;
    float: left;
    text-align: left;
    padding-top: 10px;
    padding-bottom: 15px;
} 

.div-content-body {
    #border: solid 3px blue;
    #margin-left: 270px;
    padding: 10px;
    border-left-style: solid;
    border-left-width: 2px;
}

.menu-border-top {
    border-top-style: solid;
    border-top-width: 2px;
} 

.menu-border-left {
    border-left-style: solid;
    border-left-width: 2px;
}

.menu-border-right {
    border-right-style: solid;
    border-right-width: 2px;
}

.menu-border-bottom {
    border-bottom-style: solid;
    border-bottom-width: 2px;
}

.menu-top-item {
    text-decoration: none;
    font-size: larger;
    white-space: nowrap;
}

.menu-top-item-selected {
    font-size: larger;
    font-weight: bold;
    white-space: nowrap;
}

.menu-panel-left-item {
    padding-left: 15px;
    text-decoration: none; 
    font-size: larger;
}

.menu-panel-left-item-selected {
    padding-left: 25px;
    font-size: larger;
    font-weight: bold;
}

.nav-static-line {
    font-size: larger;
    background: #D0E0FF;
}
    
.nav-static-line > ul {
    list-style: none;
    padding: 0px;
}

.nav-static-line > ul > li {
    #border: 2px solid red;
    padding: 0px;
    float: left;    
    position: relative;
    text-align: center;
    text-decoration: none;
}
   
.nav-static-line .item {
    padding: 7px;      
    display: block;
    text-align: center;
    text-decoration: none;
}

.nav-static-line .item-selected {
    font-weight: bold;
}

.nav-mobile {
    margin: 0 auto;
	float: left;
    background: #D0E0FF;
}
   
.nav-mobile ul {
    list-style: none;
    margin: 0 auto;
    padding: 0;
}

.nav-mobile li li {
	width: 160px;
}
   
.nav-mobile > ul > li {
    float: left;
    position: relative;
    text-align: left;
    text-decoration: none;
}

.nav-mobile-group-root {
    display: none;
    position: absolute;
    top: 100%;
}

.nav-mobile li:hover > .nav-mobile-group-root {
    display: block;
}

.nav-mobile-group-child {
	display: none;
	position: absolute;
	left: 100%;
	top: 0;
}
    
.nav-mobile li li:hover > .nav-mobile-group-child-1 {
	display: block;
}

.nav-mobile li li li:hover > .nav-mobile-group-child-2 {
	display: block;
}

.nav-mobile-item {  
    padding: 6px;    
    display: block;
    text-align: left;
    text-decoration: none;
    color: #2020A0;	
}

.nav-mobile-item:hover {
   background: #2F718E;
}

.ul-articles li {
    padding-top: 17px;
}

.div-video-iframe {
    width: 560px;
    height: 315px;
}

.div-source-code {
    #border: solid 2px red;
    overflow:scroll;
    min-width: 95%;
    max-width: 200px;   
    border-style: solid;
    border-width: 1px; 
    font-family: monospace;
    text-align: left;
}

.div-download {
    border-style: solid;
    border-width: 1px;  
    text-align: center;
}

.a-download {
    text-decoration: none;
}

.div-documentation-synopsis {
    #border: solid 3px red;
    margin-left:    30px;
    margin-right:    0px; 
    margin-top:      3px;
    margin-bottom:   0px;
}

.div-documentation-desc {
    #border: solid 3px red;
    margin-left:    30px;
    margin-right:  100px; 
    margin-top:      3px;
    margin-bottom:   0px;
}

@media (max-width: 900px) {

    #header-desktop {
        display: none;
    }

    #menu-top-line-1 {
        display: none;
    }

    .div-content-panel-left {
        display: none;
    } 

    .div-content-body {
        border-left-width: 0px;
    }

    .div-video-iframe {
        width: 370px;
        height: 210px;
    }

}

@media not (max-width: 900px) {

    #header-mobile {
        display: none;
    }

}

.button-top {
  display: none; 
  position: fixed;
  right: 10px;
  bottom: 40px;
  cursor: pointer;
  font-size: 18px;
  padding: 5px 8px;
  border-style: solid; 
  border-width: 2px;
}

.button-top-visible {
  display: block;
} 
</style>


<title>PGHist | Документация</title>
	
</head>
<body>

<div id="header-desktop" class="div-page background-header menu-border-bottom border-color-menu" style="justify-content: center; padding: 10px;">

  <h1>PGHist | Документация</h1>

</div>


<div class='div-page' style='flex: 1; clear:both;'>

  <div class='div-content-panel-left'>
    

<ul>
<li><a href="#hist_enable">pghist.hist_enable</a></li>
<li><a href="#view_hist">[schema].[table]_hist</a></li>
<li><a href="#table_changes">[schema].[table]_changes</a></li>
<li><a href="#table_at_timestamp">[schema].[table]_at_timestamp</a></li>
<li><a href="#hist_disable">pghist.hist_disable</a></li>
<li><a href="#hist_expression_desc">SQL-выражения описаний</a></li>
<li><a href="#hist_custom_funcs">Функции кастомизации</a></li>
<li><a href="#hist_table">Таблица истории</a></li>
<li><a href="#common_tables">Общие таблицы</a></li>
<li><a href="#pghist_version">pghist.pghist_version</a></li>
<li><a href="#hist_sql_log">pghist.hist_sql_log</a></li>
</ul>




  </div>

  <div class='div-content-body border-content-body border-color-menu'>
    

<a id="hist_enable"></a>
<p style="font-size:larger;"><b>pghist.hist_enable</b>(schema name, table_name name, master_table_schema, master_table_name)</p>
<br>
Процедура включает ведение истории изменений для указанной таблицы, создает таблицу истории, триггеры и функции получения данных
<br>
<br>
Параметры:
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="text-align: center; width: 30px;">-</td><td>схема таблицы (необязательно)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_name</td><td style="text-align: center; width: 30px;">-</td><td>имя таблицы</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">master_table_schema</td><td style="text-align: center; width: 30px;">-</td><td>схема мастер-таблицы (необязательно)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">master_table_name</td><td style="text-align: center; width: 30px;">-</td><td>имя мастер-таблицы (необязательно)</td></tr>
</table>


<br>
Примеры вызова:<br>
<div class="div-source-code border-color-div-source-code" style="width: 60%; height: 100px;">
<pre><span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'document'</span>);
<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);
<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, <span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>



<a id="view_hist"></a>
<p style="font-size:larger;"><b>[schema].[table]_hist</b></p>
<br>
Представление содержит список изменений по строкам, создается при включении ведения истории.<br>
Сортируется по первым двум столбцам, что обеспечивает хронологию по времени<br>

<br>
Столбцы:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_statement_num</td><td style="text-align: center; width: 30px;">-</td><td>глобальный номер SQL-выражения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_row_num</td><td style="text-align: center; width: 30px;">-</td><td>номер строки в наборе данных, который изменяет SQL-выражения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_timestamp</td><td style="text-align: center; width: 30px;">-</td><td>дата-время начала выполнения SQL-выражения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_operation</td><td style="text-align: center; width: 30px;">-</td><td>операция: INSERT,UPDATE,DELETE,TRUNCATE</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_update_columns</td><td style="text-align: center; width: 30px;">-</td><td>список обновленных столбцов для операции UPDATE</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_db_user</td><td style="text-align: center; width: 30px;">-</td><td>пользователь базы данных</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_app_user</td><td style="text-align: center; width: 30px;">-</td><td>пользователь приложения, определяется как current_setting('app.user')</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_application_name</td><td style="text-align: center; width: 30px;">-</td><td>имя приложения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_query_text</td><td style="text-align: center; width: 30px;">-</td><td>текст SQL-запроса</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_statement_id</td><td style="text-align: center; width: 30px;">-</td><td>ID SQL-выражения, ссылается на таблицу pghist.hist_statement</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[primary key column(s)]</td><td style="text-align: center; width: 30px;">-</td><td>значение первичного ключа (можно быть несколько)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column(s) of foreign key on master table]</td><td style="text-align: center; width: 30px;">-</td><td>значение внешного ключа на мастер-таблицу (необязательно, можно быть несколько)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column...]_old</td><td style="text-align: center; width: 30px;">-</td><td>старое значение для каждого столбца таблицы [schema].[table]</td></tr>
</table>


<br>
Примеры вызова:<br>
<div class="div-source-code border-color-div-source-code" style="width: 60%; height: 110px;">
<pre><span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist <span class="color-source-sql-keyword">where</span> id=2;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist <span class="color-source-sql-keyword">where</span> hist_operation=<span class="color-source-sql-string">'DELETE'</span>;

</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>



<a id="table_changes"></a>
<p style="font-size:larger;"><b>[schema].[table]_changes</b>(where_clause text, where_param anyelement, cascade boolean)</p>
<br>
Функция возвращает изменения в таблице (setof pghist.table_change), создается при включении ведения истории.<br>
Сортировка по первым трем столбцам обеспечивает хронологию по времени, 
для получения связанных данных из нескольких таблиц рекомендуется использовать оператор <em>union all</em>

<br>
<br>
Параметры:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">where_clause</td><td style="text-align: center; width: 30px;">-</td><td>условие на таблицу (необязательный)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">where_param</td><td style="text-align: center; width: 30px;">-</td><td>значение параметра в where_clause (необязательный)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">columns_immutable</td><td style="text-align: center; width: 30px;">-</td><td>возвращать значения неизменямых столбцов (по умолчанию false)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">insert_detail</td><td style="text-align: center; width: 30px;">-</td><td>детализировать операцию INSERT по столбцам (по умолчанию false)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">cascade</td><td style="text-align: center; width: 30px;">-</td><td>учитывать унаследованные таблицы (по умолчанию true)</td></tr>
</table>


<br>
Столбцы возвращаемого набора данных:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">statement_num</td><td style="text-align: center; width: 30px;">-</td><td>глобальный номер SQL-выражения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">row_num</td><td style="text-align: center; width: 30px;">-</td><td>номер строки в наборе данных, который изменяет SQL-выражения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_num</td><td style="text-align: center; width: 30px;">-</td><td>номер столбца в строке</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">timestamp</td><td style="text-align: center; width: 30px;">-</td><td>дата-время операции</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">operation</td><td style="text-align: center; width: 30px;">-</td><td>операция: INSERT,UPDATE,DELETE,TRUNCATE</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">operation_name</td><td style="text-align: center; width: 30px;">-</td><td>наименование операции, задается переопределяемой функцией pghist.hist_custom_operation_name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_name</td><td style="text-align: center; width: 30px;">-</td><td>имя столбца</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_comment</td><td style="text-align: center; width: 30px;">-</td><td>комментарий столбца</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">value_old</td><td style="text-align: center; width: 30px;">-</td><td>старое значение</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">value_old_desc</td><td style="text-align: center; width: 30px;">-</td><td>описание старого значения, можно переопредилить через процедуру pghist.hist_expression_value_desc</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">value_new</td><td style="text-align: center; width: 30px;">-</td><td>новое значение</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">value_new_desc</td><td style="text-align: center; width: 30px;">-</td><td>описание нового значение, можно переопредилить через процедуру pghist.hist_expression_value_desc</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">row_desc</td><td style="text-align: center; width: 30px;">-</td><td>описание строки, можно переопредилить через процедуру pghist.hist_expression_row_desc</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">db_user</td><td style="text-align: center; width: 30px;">-</td><td>пользователь базы данных</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">db_user_name</td><td style="text-align: center; width: 30px;">-</td><td>имя пользователя базы данных, задается переопределяемой функцией pghist.hist_custom_db_user_name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_user</td><td style="text-align: center; width: 30px;">-</td><td>пользователь приложения, задается переопределяемой функцией pghist.hist_custom_app_user</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_user_name</td><td style="text-align: center; width: 30px;">-</td><td>имя пользователя приложения, задается переопределяемой функцией pghist.hist_custom_app_user_name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="text-align: center; width: 30px;">-</td><td>схема</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_name</td><td style="text-align: center; width: 30px;">-</td><td>имя таблицы</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_comment</td><td style="text-align: center; width: 30px;">-</td><td>комментарий таблицы</td></tr>
</table>


<br>
Примеры вызова:<br>
<div class="div-source-code border-color-div-source-code" style="width: 60%; height: 110px;">
<pre><span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_changes();
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_product_changes(<span class="color-source-sql-string">'id=&dollar;1'</span>,2)
  <span class="color-source-sql-keyword">where</span> column_name <span class="color-source-sql-keyword">not</span> <span class="color-source-sql-keyword">in</span> (<span class="color-source-sql-string">'id'</span>,<span class="color-source-sql-string">'invoice_id'</span>)
  <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> hist_id <span class="color-source-sql-keyword">desc</span>,column_pos
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>



<a id="table_at_timestamp"></a>
<p style="font-size:larger;"><b>[schema].[table]_at_timestamp</b>(transaction_start timestamptz, cascade boolean)</p>
<br>
Функция создает временную таблицу [schema]_[table]_at_timestamp как копию исходной таблицы по состоянию на момент времени и возращает ее
<br>
<br>
Параметры:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">transaction_timestamp</td><td style="text-align: center; width: 30px;">-</td><td>дата-время завершения транзации, по умолчанию current_setting('pghist.at_timestamp')</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">cascade</td><td style="text-align: center; width: 30px;">-</td><td>учитывать унаследованные таблицы (по умолчанию true)</td></tr>
</table>

<br>
Примеры вызова:<br>
<div class="div-source-code border-color-div-source-code" style="width: 60%; height: 180px;">
<pre><span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_at_timestamp(now()-<span class="color-source-sql-keyword">interval</span> <span class="color-source-sql-string">'1 hour'</span>);

<span class="color-source-sql-keyword">do</span> &dollar;&dollar;
<span class="color-source-sql-keyword">begin</span>
  perform set_config(<span class="color-source-sql-string">'pghist.at_timestamp'</span>, <span class="color-source-sql-string">'2024-04-06 10:00:00'</span>, <span class="color-source-sql-keyword">true</span>);    
  perform example.invoice_at_timestamp();    
  perform example.customer_at_timestamp();
<span class="color-source-sql-keyword">end</span>; 
&dollar;&dollar;;
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>



<a id="hist_disable"></a>
<p style="font-size:larger;"><b>pghist.hist_disable</b>(schema name, table_name name)</p>
<br>
Процедура выключает ведение истории изменений для указанной таблицы, удаляет необходимые объекты
<br>
<br>
Параметры:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="text-align: center; width: 30px;">-</td><td>схема таблицы (необязательный)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_name</td><td style="text-align: center; width: 30px;">-</td><td>имя таблицы</td></tr>
</table>

<br>
Примеры вызова:<br>
<div class="div-source-code border-color-div-source-code" style="width: 60%; height: 70px;">
<pre><span class="color-source-sql-keyword">call</span> pghist.hist_disable(<span class="color-source-sql-string">'document'</span>);
<span class="color-source-sql-keyword">call</span> pghist.hist_disable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);
</pre>
</div>


<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>



<a id="hist_expression_desc"></a>
<p style="font-size:larger;"><b>SQL-выражения описаний</b></p>
<br>
<b>pghist.hist_expression_row_desc</b>(schema name, table_name name, expression varchar)<br>
<b>pghist.hist_expression_value_desc</b>(schema name, table_name name, column_name name, expression varchar)
<br>
<br>
Процедуры устанавливают выражение для описания строки/значения поля,
в выражении доступна переменная <em>$1</em> c строкой/значением поля
<br>
<br>
<br>
<b>pghist.hist_expression_row_desc_current</b>(schema name, table_name name)<br>
<b>pghist.hist_expression_value_desc_current</b>(schema name, table_name name, column_name name)
<br>
<br>
Функции возвращают текущее выражение для описания строки/значения поля
<br>
<br>
<br>
<b>pghist.hist_expression_row_desc_default</b>(schema name, table_name name)<br>
<b>pghist.hist_expression_value_desc_default</b>(schema name, table_name name, column_name name)
<br>
<br>
Функции возвращают выражение по умолчанию для описания строки/значения поля. 
Для строки возращается комментарий таблицы с первичным ключом,
для столбца, являющегося внешним ключом, - первое текстовое поля связанной таблицы.
<br>
<br>
<br>
Параметры:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="text-align: center; width: 30px;">-</td><td>схема таблицы</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table</td><td style="text-align: center; width: 30px;">-</td><td>имя таблицы</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_name</td><td style="text-align: center; width: 30px;">-</td><td>имя столбца</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">expression</td><td style="text-align: center; width: 30px;">-</td><td>выражение, null отменяет сохраненное описание</td></tr>
</table>

<br>
Примеры вызова:<br>
<div class="div-source-code border-color-div-source-code" style="height: 130px;">
<pre><span class="color-source-sql-keyword">call</span> pghist.hist_expression_row_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>, <span class="color-source-sql-string">''</span><span class="color-source-sql-string">'Invoice'</span><span class="color-source-sql-string">''</span>);   
<span class="color-source-sql-keyword">call</span> pghist.hist_expression_row_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, &dollar;&dollar; <span class="color-source-sql-string">'Row #'</span>||&dollar;1.id||<span class="color-source-sql-string">' / '</span>||(<span class="color-source-sql-keyword">select</span> <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">from</span> example.product <span class="color-source-sql-keyword">where</span> id=&dollar;1.product_id) &dollar;&dollar;);
<span class="color-source-sql-keyword">call</span> pghist.hist_expression_value_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, <span class="color-source-sql-string">'color'</span>, &dollar;&dollar; <span class="color-source-sql-keyword">case</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'R'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Red'</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'B'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Blue'</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'G'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Green'</span> <span class="color-source-sql-keyword">else</span> &dollar;1 <span class="color-source-sql-keyword">end</span> &dollar;&dollar;);

<span class="color-source-sql-keyword">select</span> pghist.hist_expression_row_desc_current(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>);
<span class="color-source-sql-keyword">select</span> pghist.hist_expression_value_desc_default(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, <span class="color-source-sql-string">'color'</span>);
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>



<a id="hist_custom_funcs"></a>
<p style="font-size:larger;"><b>Функции кастомизации</b></p>
<br>
Для кастомизации и локализации полей конкретного приложения можно определить собственные функции. <br>
Рекомендуется в SQL-менеджере (например, pgAdmin или DBeaver) взять за основу функцию по умолчанию,
переопределить ее и сохранить в схеме приложения под другим именем.<br>
<br>
Столбцы, доступные для переопределения:
<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">operation_name</td><td style="text-align: center; width: 30px;">-</td><td>наименование операции</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">db_user_name</td><td style="text-align: center; width: 30px;">-</td><td>имя пользователя базы данных</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_user</td><td style="text-align: center; width: 30px;">-</td><td>пользователь приложения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_user_name</td><td style="text-align: center; width: 30px;">-</td><td>имя пользователя приложения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_client_addr</td><td style="text-align: center; width: 30px;">-</td><td>IP адрес клиентского приложения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_client_hostname</td><td style="text-align: center; width: 30px;">-</td><td>Имя хоста(компьютера) клиентского приложения</td></tr>
</table>

<br>
<p style="font-size:larger;"><b>pghist.hist_column_custom_function</b>(column_name name, custom_function name)<p>
Процедура устанавливает функцию для получения значения поля
<br>
<br>
Параметры:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_name</td><td style="text-align: center; width: 30px;">-</td><td>имя столбца</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">custom_function</td><td style="text-align: center; width: 30px;">-</td><td>имя функции без параметров</td></tr>
</table>

<br>
<p style="font-size:larger;"><b>pghist.hist_column_custom_function_current</b>(column_name name)<p>
Функция возвращает текущую функцию для получения значения поля
<br>
<br>
Параметр:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_name</td><td style="text-align: center; width: 30px;">-</td><td>имя столбца</td></tr>
</table>

<br>
Пример:<br>
<div class="div-source-code border-color-div-source-code" style="height: 175px;">
<pre><span class="color-source-sql-keyword">select</span> pghist.hist_column_custom_function_current(<span class="color-source-sql-string">'db_user_name'</span>);

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-keyword">replace</span> <span class="color-source-sql-keyword">function</span> myapp.user_name(db_user <span class="color-source-sql-keyword">name</span>) <span class="color-source-sql-keyword">returns</span> <span class="color-source-sql-keyword">varchar</span> <span class="color-source-sql-keyword">language</span> plpgsql <span class="color-source-sql-keyword">as</span> &dollar;&dollar; 
<span class="color-source-sql-keyword">begin</span> 
  return (<span class="color-source-sql-keyword">select</span> <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">from</span> myapp.users <span class="color-source-sql-keyword">where</span> login=db_user);                                        
<span class="color-source-sql-keyword">end</span>; &dollar;&dollar;;

<span class="color-source-sql-keyword">call</span> pghist.hist_column_custom_function(<span class="color-source-sql-string">'db_user_name'</span>, <span class="color-source-sql-string">'myapp.user_name'</span>);
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="hist_table"></a>
<p style="font-size:larger;"><b>Таблица истории pghist.hist_[schema]_[table]</b></p>
<br>
При включении истории дополнительно к основной таблице создается таблица истории,
разработчику (владельцу основной таблицы) доступна через представление <a href="#view_hist">[schema].[table]_hist</a>
<br>
<br>
Столбцы:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_statement_id</td><td style="text-align: center; width: 30px;">-</td><td>ID SQL-выражения, ссылается на таблицу pghist.hist_statement</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_row_num</td><td style="text-align: center; width: 30px;">-</td><td>номер строки в наборе данных, который изменяет SQL-выражения</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_update_columns</td><td style="text-align: center; width: 30px;">-</td><td>список обновленных столбцов для операции UPDATE</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[primary key column(s)]</td><td style="text-align: center; width: 30px;">-</td><td>значение первичного ключа (можно быть несколько)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column(s) of foreign key on master table]</td><td style="text-align: center; width: 30px;">-</td><td>значение внешного ключа на мастер-таблицу (необязательно, можно быть несколько)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column...]_old</td><td style="text-align: center; width: 30px;">-</td><td>старое значение для каждого столбца таблицы [schema].[table]</td></tr>
</table>

<br>
Пример использования:<br>
<div class="div-source-code border-color-div-source-code" style="height: 130px;">
<pre><span class="color-source-sql-keyword">select</span> *
  <span class="color-source-sql-keyword">from</span> pghist.hist_example_invoice h
  <span class="color-source-sql-keyword">join</span> pghist.hist_statement s <span class="color-source-sql-keyword">on</span> s.id=h.hist_statement_id
  <span class="color-source-sql-keyword">join</span> pghist.hist_query q <span class="color-source-sql-keyword">on</span> q.hash=s.query_hash
  <span class="color-source-sql-keyword">where</span> q.<span class="color-source-sql-keyword">text</span> <span class="color-source-sql-keyword">like</span> <span class="color-source-sql-string">'do%begin%'</span>
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="common_tables"></a>
<p style="font-size:larger;"><b>Общие таблицы</b></p>
<br>
<table>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_transaction</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">транзакции</td></tr>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_query</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">SQL-запросы</td></tr>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_statement</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">SQL-выражения</td></tr>
</table>


<br>
При установке создаются таблицы, которые хранят общую информацию по изменениям:
дата-время транзакции и SQL-выражения, операция, SQL-запрос, пользователь, сессия и т.д. 
<br>
Таблица истории <a href="#hist_table">pghist.hist_[schema]_[table]</a> по полю <em>statement_id</em> ссылается на <em>pghist.hist_statement</em>, которая в свою очередь ссылается на <em>pghist.hist_transaction</em> и <em>pghist.hist_query</em>.
По умолчанию разработчикам (владельцам основных таблицы) общие таблицы недоступны, при необходимости доступ выдается вручную.
<br>
<br>
Пример использования:<br>
<div class="div-source-code border-color-div-source-code" style="height: 130px;">
<pre><span class="color-source-sql-keyword">select</span> *
  <span class="color-source-sql-keyword">from</span> pghist.hist_statement s
  <span class="color-source-sql-keyword">join</span> pghist.hist_transaction t <span class="color-source-sql-keyword">on</span> t.id=s.transaction_id
  <span class="color-source-sql-keyword">join</span> pghist.hist_query q <span class="color-source-sql-keyword">on</span> q.hash=s.query_hash
  <span class="color-source-sql-keyword">where</span> t.timestamp_commit <span class="color-source-sql-keyword">between</span> <span class="color-source-sql-string">'2024-04-06 10:00:00'</span> <span class="color-source-sql-keyword">and</span> <span class="color-source-sql-string">'2024-04-06 11:00:00'</span>;
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>



<a id="pghist_version"></a>
<p style="font-size:larger;"><b>pghist.pghist_version</b>()</p>
<br>
Функция возвращает версию инструмента
<br>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>



<a id="hist_sql_log"></a>
<p style="font-size:larger;"><b>pghist.hist_sql_log</b></p>
<br>
Все команды, выполняемые утилитой, записываются в лог-таблицу pghist.hist_sql_log
<br>
<br>
Примеры использования:<br>
<div class="div-source-code border-color-div-source-code" style="height: 140px;">
<pre><span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> pghist.hist_sql_log <span class="color-source-sql-keyword">where</span> <span class="color-source-sql-keyword">schema</span>=<span class="color-source-sql-string">'example'</span> <span class="color-source-sql-keyword">and</span> table_name=<span class="color-source-sql-string">'document'</span> <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> id;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> pghist.hist_sql_log l
  <span class="color-source-sql-keyword">join</span> pghist.hist_transaction t <span class="color-source-sql-keyword">on</span> t.id=l.transaction_id
  <span class="color-source-sql-keyword">where</span> <span class="color-source-sql-keyword">schema</span>=<span class="color-source-sql-string">'example'</span> <span class="color-source-sql-keyword">and</span> table_name=<span class="color-source-sql-string">'document'</span>
  <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1 <span class="color-source-sql-keyword">desc</span>;
</pre>
</div>



  </div>

</div>

</body>
</html>